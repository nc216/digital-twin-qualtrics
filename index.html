<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Digital Twin Chat</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      background: #f5f5f5;
      height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
    }
    #chat-container {
      width: 100%; max-width: 600px; height: 520px;
      background: #fff; border-radius: 12px;
      box-shadow: 0 2px 12px rgba(0,0,0,0.1);
      display: flex; flex-direction: column; overflow: hidden;
    }
    #chat-header {
      background: #4a90d9; color: #fff;
      padding: 14px 20px; font-size: 16px; font-weight: 600;
    }
    #chat-messages {
      flex: 1; overflow-y: auto; padding: 16px;
      display: flex; flex-direction: column; gap: 10px;
    }
    .msg {
      max-width: 80%; padding: 10px 14px; border-radius: 16px;
      font-size: 14px; line-height: 1.45; word-wrap: break-word;
    }
    .msg.user {
      align-self: flex-end; background: #4a90d9; color: #fff;
      border-bottom-right-radius: 4px;
    }
    .msg.assistant {
      align-self: flex-start; background: #e9ecef; color: #222;
      border-bottom-left-radius: 4px;
    }
    .msg.system {
      align-self: center; background: #fff3cd; color: #856404;
      font-size: 13px; border-radius: 8px;
    }
    #typing {
      align-self: flex-start; color: #999; font-size: 13px;
      font-style: italic; padding: 4px 14px; display: none;
    }
    #input-area {
      display: flex; border-top: 1px solid #e0e0e0;
      padding: 10px; gap: 8px;
    }
    #user-input {
      flex: 1; border: 1px solid #ccc; border-radius: 20px;
      padding: 10px 16px; font-size: 14px; outline: none;
      font-family: inherit; height: 40px;
    }
    #user-input:focus { border-color: #4a90d9; }
    #user-input:disabled { background: #f0f0f0; }
    #send-btn {
      background: #4a90d9; color: #fff; border: none;
      border-radius: 20px; padding: 0 20px; font-size: 14px;
      cursor: pointer; font-weight: 600;
    }
    #send-btn:hover { background: #357abd; }
    #send-btn:disabled { background: #aaa; cursor: not-allowed; }
    #status {
      text-align: center; padding: 6px; font-size: 12px; color: #888;
    }
  </style>
</head>
<body>
  <div id="chat-container">
    <div id="chat-header">Conversation</div>
    <div id="chat-messages">
      <div id="typing">Typing...</div>
    </div>
    <div id="input-area">
      <input id="user-input" type="text" placeholder="Type a message..." autocomplete="off" disabled />
      <button id="send-btn" disabled>Send</button>
    </div>
    <div id="status">Loading persona...</div>
  </div>

<script>
const PROXY_URL = "https://script.google.com/macros/s/AKfycbxUCOU5JqXGabGyKN7lcv7YuKj_8B-Jjt_0n3Lq8pEtwljYvzDKXOaC86lbcSYJW7fI/exec";

let persona = null;
let personaId = null;
let history = [];
let turnCount = 0;
let maxTurns = 20;
let finished = false;

const messagesEl = document.getElementById("chat-messages");
const inputEl = document.getElementById("user-input");
const sendBtn = document.getElementById("send-btn");
const typingEl = document.getElementById("typing");
const statusEl = document.getElementById("status");
const headerEl = document.getElementById("chat-header");

function param(name) {
  return new URLSearchParams(window.location.search).get(name);
}

function addMsg(role, text) {
  const div = document.createElement("div");
  div.className = "msg " + role;
  div.textContent = text;
  messagesEl.insertBefore(div, typingEl);
  messagesEl.scrollTop = messagesEl.scrollHeight;
}

function setEnabled(on) {
  inputEl.disabled = !on;
  sendBtn.disabled = !on;
}

async function init() {
  const turnsParam = param("maxturns");
  if (turnsParam) maxTurns = parseInt(turnsParam, 10);

  // Load personas JSON (hosted alongside this file)
  try {
    const res = await fetch("personas.json");
    const personas = await res.json();
    const pids = Object.keys(personas);

    // Pick persona: from URL param or random
    const pidParam = param("pid");
    if (pidParam && personas[pidParam]) {
      personaId = pidParam;
    } else {
      personaId = pids[Math.floor(Math.random() * pids.length)];
    }
    persona = personas[personaId];

    headerEl.textContent = "Conversation (Persona #" + personaId + ")";
    statusEl.textContent = "Turn 0 / " + maxTurns;
    addMsg("assistant", "Hi! Feel free to ask me anything.");
    setEnabled(true);
    inputEl.focus();
  } catch (err) {
    addMsg("system", "Error loading personas: " + err.message);
  }
}

async function sendMessage() {
  const text = inputEl.value.trim();
  if (!text || !persona || finished) return;

  addMsg("user", text);
  inputEl.value = "";
  setEnabled(false);
  typingEl.style.display = "block";

  // Build system prompt with persona
  const systemPrompt =
    "You are roleplaying as a specific person. You must stay in character at all times and respond as this person would, based on their profile below. Do not break character. Do not reveal that you are an AI. Respond naturally and conversationally.\n\n--- PERSONA PROFILE ---\n" +
    persona +
    "\n--- END PERSONA PROFILE ---";

  try {
    const res = await fetch(PROXY_URL, {
      method: "POST",
      headers: { "Content-Type": "text/plain" },
      body: JSON.stringify({
        system: systemPrompt,
        history: history,
        message: text
      })
    });
    const data = await res.json();
    typingEl.style.display = "none";

    if (data.error) throw new Error(data.error);

    const reply = data.output_text || "(no response)";
    addMsg("assistant", reply);

    history.push({ role: "user", content: text });
    history.push({ role: "assistant", content: reply });
    turnCount++;
    statusEl.textContent = "Turn " + turnCount + " / " + maxTurns;

    if (turnCount >= maxTurns) {
      endChat();
      return;
    }
    setEnabled(true);
    inputEl.focus();
  } catch (err) {
    typingEl.style.display = "none";
    addMsg("system", "Error: " + err.message);
    setEnabled(true);
  }
}

function endChat() {
  finished = true;
  setEnabled(false);
  addMsg("system", "Conversation complete. Thank you!");
  statusEl.textContent = "Finished (" + turnCount + " turns)";

  // Send transcript to Qualtrics parent via postMessage
  try {
    window.parent.postMessage({
      type: "chatbot_transcript",
      session_id: personaId + "_" + Date.now(),
      persona_id: personaId,
      transcript: JSON.stringify(history),
      turn_count: turnCount
    }, "*");
  } catch (_) {}
}

sendBtn.addEventListener("click", sendMessage);
inputEl.addEventListener("keydown", function(e) {
  if (e.key === "Enter" && !e.shiftKey) { e.preventDefault(); sendMessage(); }
});

init();
</script>
</body>
</html>
